<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>EANO Coin Mining</title>
  <style>
    body { font-family: Arial; padding: 20px; text-align: center; }
    #mineBtn { padding: 10px 20px; font-size: 18px; }
    #walletInput { padding: 10px; width: 60%; }
    #status, #referralInfo { margin-top: 15px; font-weight: bold; }
  </style>
</head>
<body>
  <h1>EANO Coin Mining</h1>

  <input type="text" id="walletInput" placeholder="Enter your EANO Wallet Address">
  <br><br>
  <button id="mineBtn">Mine EANO</button>
  <div id="status">⛏ Mined: <span id="minedDisplay">0</span> EANO</div>
  <div id="referralInfo"></div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_BUCKET",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    console.log("✅ Firebase connected");

    const walletInput = document.getElementById("walletInput");
    const mineBtn = document.getElementById("mineBtn");
    const minedDisplay = document.getElementById("minedDisplay");
    const referralInfo = document.getElementById("referralInfo");

    let minedData = JSON.parse(localStorage.getItem("minedData") || "{}");

    function getTrust() {
      return Math.floor(Math.random() * 100); // You can make this smarter
    }

    // Load referrer from ?ref=
    const urlParams = new URLSearchParams(window.location.search);
    const referrer = urlParams.get("ref");
    if (referrer) {
      localStorage.setItem("referrer", referrer);
      referralInfo.innerText = `You were referred by: ${referrer}`;
    }

    // Update display if user has mined before
    walletInput.addEventListener("input", () => {
      const wallet = walletInput.value.trim();
      if (wallet && minedData[wallet]) {
        minedDisplay.textContent = minedData[wallet];
      } else {
        minedDisplay.textContent = "0";
      }
    });

    mineBtn.onclick = async () => {
      const wallet = walletInput.value.trim();
      if (!wallet) return alert("Enter a valid wallet address");

      // Update mined data
      if (!minedData[wallet]) {
        minedData[wallet] = 0;

        // First-time miner: Give referral credit
        const storedReferrer = localStorage.getItem("referrer");
        if (storedReferrer && storedReferrer !== wallet) {
          try {
            const refDoc = doc(db, "miners", storedReferrer);
            await updateDoc(refDoc, { referrals: increment(1) });
            console.log("✅ Referrer credited:", storedReferrer);
          } catch (e) {
            console.log("⚠️ Could not credit referrer:", e.message);
          }
        }
      }

      minedData[wallet]++;
      localStorage.setItem("minedData", JSON.stringify(minedData));
      minedDisplay.textContent = minedData[wallet];

      // Save to Firestore
      try {
        const minerRef = doc(db, "miners", wallet);
        await setDoc(minerRef, {
          wallet,
          mined: minedData[wallet],
          trust: getTrust(),
          referrals: 0,
          timestamp: new Date().toISOString()
        }, { merge: true });

        console.log("✅ Synced to Firestore");
      } catch (err) {
        console.error("❌ Firestore error:", err);
      }
    };
  </script>
</body>
</html>
